<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
sampler-scaffold

@element sampler-scaffold
@homepage github.io
-->

<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-menu/core-submenu.html">

<polymer-element name="sampler-scaffold" attributes="label responsiveWidth sample hideAction">
<template>

  <link rel="stylesheet" href="sampler-scaffold.css">

  <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsiveWidth="{{responsiveWidth}}">

    <core-header-panel drawer mode="waterfall">

      <core-toolbar class="{{ {tall : !narrow} | tokenList }}">
        <div>{{label}}</div>
      </core-toolbar>
      
      <core-menu id="menu" on-core-activate="{{togglePanel}}" on-core-select="{{menuSelect}}">
        <template repeat="{{items}}">
          <core-submenu src="code.png" name="{{name}}" label="{{label || name}}" on-core-activate="{{togglePanel}}">
            <template repeat="{{items}}">
              <core-item src="code.png" name="{{name}}" label="{{label || name}}"></core-item>
            </template>
          </core-submenu>
        </template>
      </core-menu>

    </core-header-panel>
    
    <core-header-panel id="mainHeaderPanel" main mode="{{narrow ? 'waterfall' : 'cover'}}">

      <core-toolbar class="{{ {tall : !narrow} | tokenList }}">
        <core-icon-button id="menuButton" icon="menu" on-tap="{{togglePanel}}"></core-icon-button>
        <div core-flex class="toolbar-label">{{item.tag ? '&lt;' + item.tag + '&gt;' : item.name}}</div>
        <core-icon-button class="action-button" hidden?="{{hideAction}}" icon="launch" theme="core-dark-theme" on-click="{{viewSourceAction}}"></core-icon-button>
      </core-toolbar>
      
      <core-selector id="card" selected="{{selected}}" valueattr="label" selectedItem="{{sample}}" on-transitionend="{{cardTransitionDone}}">

        <content id="samples" select="*"></content>
        
      </core-selector>
      
    </core-header-panel>

  </core-drawer-panel>

</template>
<script>

  Polymer('sampler-scaffold', {
    
    responsiveWidth: '860px',
    
    hideAction: false,
    
    attached: function() {
      this.updateMenu();
      this.async(function() {
        this.$.menu.selected = 0;
      }, null, 300);
    },
    
    updateMenu: function() {
      this.items = [];
      this.$.card.items.forEach(function(s) {
        var newItem = {
          name: s.getAttribute('label'),
          tag: s.getAttribute('tag')
        };
        var foundItem;
        for (var i = 0, item; item = this.items[i]; i++) {
          if (item.tag === newItem.tag) {
            foundItem = item;
            break;
          }
        }
        if (foundItem && foundItem.tag) {
          var l = foundItem.items
          if (!l) {
            l = foundItem.items = [];
            foundItem.label = foundItem.name.split('/').shift();
            l.push({
              name: foundItem.name,
              label: foundItem.name.split('/').pop(),
              tag: foundItem.tag
            });
          }
          newItem.label = newItem.name.split('/').pop();
          l.push(newItem);
        } else {
          this.items.push(newItem);
        }
      }.bind(this));
    },
    
    menuSelect: function(e, detail) {
      if (detail.isSelected) {
        this.item = detail.item.templateInstance.model;
        this.selected = this.item.name;
      }
    },
    
    selectedChanged: function() {
      if (!this.narrow) {
        this.animateCard();
      }
    },
    
    animateCard: function() {
      this.$.card.classList.remove('transition');
      this.$.card.style.display = 'none';
      this.async(function() {
        this.$.card.style.display = 'block';
        this.moveCard(this.$.mainHeaderPanel.offsetHeight);
        this.async(function() {
          this.$.card.classList.add('transition');
          this.moveCard(null);
        }, null, 100);
      });
    },
    
    moveCard: function(y) {
      var s = this.$.card.style;
      s.webkitTransform = s.transform = 
          y ? 'translate3d(0, ' + y + 'px,0)' : null;
    },
    
    cardTransitionDone: function() {
      this.$.card.classList.remove('transition');
      if (this.sample) {
        this.sample.updateFrameHeight();
      }
    },
    
    togglePanel: function() {
      this.$.drawerPanel.togglePanel();
    },
    
    viewSourceAction: function() {
      var frame = this.sample && this.sample.frame;
      if (frame) {
        window.open('view-source:' + frame.src, this.sample.tag);
      }
    }
    
  });

</script>
</polymer-element>
